# دليل التطبيق السريع - نظام ربط المصروفات بالعهدة

## نظرة عامة

تم تطوير نظام متكامل لربط المصروفات بعهد الموظفين مع آلية تأكيد استلام العهدة. هذا الدليل يوضح خطوات التطبيق.

## المتطلبات

- [x] حساب Supabase نشط
- [x] صلاحيات SQL Editor في Supabase
- [x] التطبيق يعمل على أحدث إصدار من الكود

## خطوات التطبيق

### الخطوة 1: تطبيق تعديلات قاعدة البيانات ⚠️ **مهم جداً**

1. **افتح Supabase Dashboard**
   - اذهب إلى [app.supabase.com](https://app.supabase.com)
   - اختر مشروعك

2. **افتح SQL Editor**
   - من القائمة الجانبية، اختر "SQL Editor"
   - اضغط "+ New Query"

3. **تنفيذ Migration**
   - افتح ملف `migrations/001_add_custody_fields.sql`
   - انسخ محتوياته بالكامل
   - الصقه في SQL Editor
   - اضغط "Run" أو اضغط `Ctrl + Enter`

4. **التحقق من النجاح**
   يجب أن ترى رسالة:
   ```
   Success. No rows returned
   ```

   إذا رأيت أي أخطاء:
   - تأكد من نسخ الكود كاملاً
   - تحقق من وجود الجداول `expenses` و `employee_balance_transactions`
   - راجع رسالة الخطأ واتصل بالدعم الفني إذا لزم الأمر

### الخطوة 2: التحقق من التحديثات

1. **تحقق من جدول expenses**
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'expenses' 
   AND column_name IN ('user_id', 'balance_transaction_id', 'deducted_from_custody');
   ```
   
   يجب أن ترى الأعمدة الثلاثة الجديدة.

2. **تحقق من جدول employee_balance_transactions**
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'employee_balance_transactions' 
   AND column_name IN ('status', 'confirmed_at', 'confirmed_by');
   ```
   
   يجب أن ترى الأعمدة الثلاثة الجديدة.

### الخطوة 3: الاختبار الأولي

#### اختبار 1: إضافة عهدة معلقة
1. سجل دخول كمدير
2. اذهب إلى "عهد الموظفين"
3. اختر موظف
4. أضف عهدة جديدة بمبلغ 500 ر.س
5. تحقق من:
   - ظهور رسالة "في انتظار تأكيد الموظف"
   - عدم تحديث الرصيد فوراً

#### اختبار 2: تأكيد العهدة
1. سجل دخول كالموظف نفسه
2. اذهب إلى "عهد الموظفين"
3. يجب أن ترى قسم "العهد في انتظار التأكيد"
4. اضغط "تأكيد الاستلام"
5. تحقق من:
   - تحديث الرصيد إلى 500 ر.س
   - اختفاء العهدة من قسم المعلقة
   - ظهورها في السجل

#### اختبار 3: إضافة مصروف مع خصم من العهدة
1. سجل دخول كالموظف
2. اذهب إلى "إدارة المصروفات"
3. أضف مصروف بمبلغ 100 ر.س
4. فعّل "خصم من العهدة"
5. تحقق من:
   - عرض الرصيد الحالي (500 ر.س)
   - عرض الرصيد بعد الخصم (400 ر.س)
   - نجاح الحفظ
   - تحديث الرصيد إلى 400 ر.س

### الخطوة 4: الاختبار الشامل

راجع ملف `TESTING_CHECKLIST.md` ونفذ جميع سيناريوهات الاختبار المذكورة.

## الأخطاء الشائعة وحلولها

### خطأ: "column already exists"
**السبب:** تم تنفيذ migration مسبقاً
**الحل:** لا داعي لفعل شيء، التحديثات موجودة بالفعل

### خطأ: "table does not exist"
**السبب:** الجداول الأساسية غير موجودة
**الحل:** تأكد من وجود جداول `expenses` و `employee_balance_transactions` و `user_profiles`

### خطأ: "permission denied"
**السبب:** المستخدم ليس لديه صلاحيات كافية
**الحل:** استخدم حساب صاحب المشروع أو admin

### مشكلة: لا تظهر checkbox "خصم من العهدة"
**السبب:** الكود لم يتم تحديثه
**الحل:** تأكد من pull أحدث تغييرات من branch `copilot/link-expenses-to-custody`

### مشكلة: لا تظهر العهد المعلقة
**السبب:** لا توجد عهد بحالة pending
**الحل:** أضف عهدة جديدة من حساب المدير

## نصائح مهمة

1. **النسخ الاحتياطي**
   - قبل تطبيق أي تغييرات، أخذ نسخة احتياطية من قاعدة البيانات
   - في Supabase: Settings → Database → Backups

2. **البيئة التجريبية**
   - يُفضل الاختبار في بيئة تطوير أولاً
   - انشئ مشروع Supabase منفصل للاختبار

3. **المراقبة**
   - راقب logs في Supabase بعد التطبيق
   - تحقق من عدم وجود أخطاء في Console المتصفح

4. **التدريب**
   - درّب الموظفين على المميزات الجديدة
   - شارك ملف `CUSTODY_INTEGRATION.md` معهم

## الدعم

إذا واجهت أي مشاكل:

1. راجع الـ Console في المتصفح للأخطاء
2. تحقق من Supabase logs
3. راجع ملف `TESTING_CHECKLIST.md`
4. تواصل مع الدعم الفني

## الخطوات التالية

بعد التطبيق الناجح:

1. ✅ راجع جميع الاختبارات في `TESTING_CHECKLIST.md`
2. ✅ درّب الموظفين على النظام الجديد
3. ✅ راقب الأداء والاستخدام
4. ✅ اجمع feedback من المستخدمين
5. ✅ وثّق أي تحسينات مطلوبة

## معلومات تقنية إضافية

### الحقول المضافة

**expenses:**
- `user_id`: UUID - معرّف الموظف الذي أضاف المصروف
- `balance_transaction_id`: UUID - معرّف معاملة العهدة المرتبطة
- `deducted_from_custody`: BOOLEAN - هل تم الخصم من العهدة

**employee_balance_transactions:**
- `status`: VARCHAR(20) - حالة المعاملة (pending, confirmed, rejected)
- `confirmed_at`: TIMESTAMP - تاريخ التأكيد
- `confirmed_by`: UUID - من قام بالتأكيد

### الفهارس (Indexes)

تم إضافة فهارس على:
- `expenses.user_id`
- `expenses.balance_transaction_id`
- `employee_balance_transactions.status`

هذه الفهارس تحسّن أداء الاستعلامات.

---

**ملاحظة:** هذا النظام يعمل بشكل مترابط، تأكد من تطبيق جميع الخطوات بالترتيب.
