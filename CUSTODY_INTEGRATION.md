# نظام ربط المصروفات بالعهدة وتأكيد الاستلام

## نظرة عامة

تم تطوير نظام متكامل لربط المصروفات بعهد الموظفين مع إضافة آلية تأكيد استلام العهدة من قبل الموظف.

## المميزات الجديدة

### 1. خصم المصروفات من عهدة الموظف

عند إضافة مصروف، يمكن للموظف:
- اختيار خصم المبلغ من عهدته
- رؤية الرصيد المتاح والرصيد المتوقع بعد الخصم
- الحصول على تحذير إذا كان الرصيد غير كافٍ
- تأكيد عملية الخصم قبل الحفظ

**سير العمل:**
1. عند إضافة مصروف جديد، يعرض النظام رصيد العهدة الحالي
2. يمكن للموظف تفعيل خيار "خصم من العهدة"
3. النظام يتحقق من كفاية الرصيد
4. عند التأكيد، يتم:
   - حفظ المصروف مع ربطه بالموظف
   - إنشاء معاملة خصم (debit) في سجل العهد
   - تحديث رصيد الموظف تلقائياً
   - عرض الرصيد الجديد بعد الخصم

### 2. نظام تأكيد استلام العهدة

عند إضافة عهدة جديدة للموظف:

**من جانب المدير:**
- إضافة العهدة بحالة "pending" (في انتظار التأكيد)
- لا يتم تحديث رصيد الموظف فوراً
- يمكن رؤية العهد المعلقة في صفحة الموظف

**من جانب الموظف:**
- يرى قسم "العهد في انتظار التأكيد" في صفحته
- تفاصيل كل عهدة معلقة تشمل:
  - المبلغ
  - التاريخ
  - السبب/الوصف
  - من قام بإضافتها
- خيارات متاحة:
  - ✅ **تأكيد الاستلام**: يتم تحديث الرصيد وتحويل الحالة إلى confirmed
  - ❌ **رفض**: يتم رفض العهدة بدون تحديث الرصيد

## التغييرات التقنية

### قاعدة البيانات

#### جدول `expenses`
```sql
- user_id: UUID (reference to user_profiles)
- balance_transaction_id: UUID (reference to employee_balance_transactions)
- deducted_from_custody: BOOLEAN
```

#### جدول `employee_balance_transactions`
```sql
- status: VARCHAR(20) DEFAULT 'confirmed'
  - 'pending': في انتظار التأكيد
  - 'confirmed': تم التأكيد
  - 'rejected': تم الرفض
- confirmed_at: TIMESTAMP
- confirmed_by: UUID (reference to user_profiles)
```

### الواجهات البرمجية (TypeScript)

```typescript
interface Expense {
  // ... الحقول الموجودة
  user_id?: string;
  balance_transaction_id?: string;
  deducted_from_custody?: boolean;
}

interface EmployeeBalanceTransaction {
  // ... الحقول الموجودة
  status?: 'pending' | 'confirmed' | 'rejected';
  confirmed_at?: string;
  confirmed_by?: string;
}
```

## دليل الاستخدام

### للموظفين

#### إضافة مصروف مع خصم من العهدة
1. اضغط على "إضافة مصروف"
2. املأ بيانات المصروف (الوصف، المبلغ، الفئة، التاريخ)
3. فعّل خيار "خصم من العهدة"
4. راجع الرصيد المتاح والرصيد بعد الخصم
5. اضغط "إضافة المصروف"
6. أكد عملية الخصم في النافذة المنبثقة

#### تأكيد استلام عهدة جديدة
1. انتقل إلى صفحة "عهد الموظفين"
2. في قسم "العهد في انتظار التأكيد"، ستجد العهد الجديدة
3. راجع تفاصيل العهدة (المبلغ، التاريخ، السبب)
4. اضغط "تأكيد الاستلام" لقبول العهدة
5. سيتم تحديث رصيدك تلقائياً

### للمديرين

#### إضافة عهدة للموظف
1. اختر الموظف من قائمة الموظفين
2. اضغط "عملية جديدة"
3. اختر "صرف عهده (إضافة للموظف)"
4. أدخل المبلغ والتاريخ والسبب
5. اضغط "تسجيل في العهده"
6. ستظهر العهدة كـ "معلقة" حتى يؤكدها الموظف

#### إضافة مصروف بدون خصم من العهدة
1. اضغط "إضافة مصروف"
2. املأ البيانات
3. اترك خيار "خصم من العهدة" غير مفعل
4. اضغط "إضافة المصروف"

## الرسائل التوضيحية

### رسائل النجاح
- ✅ "تم خصم المصروف من عهدتك بنجاح. الرصيد المتبقي: [المبلغ] ر.س"
- ✅ "تم إضافة المصروف بنجاح"
- ✅ "تم تأكيد استلام العهدة. رصيدك الحالي: [المبلغ] ر.س"
- ✅ "تم إضافة العهدة بنجاح. في انتظار تأكيد الموظف"

### رسائل الخطأ
- ❌ "رصيد العهدة غير كافٍ. الرصيد المتاح: [المبلغ] ر.س والمطلوب: [المبلغ] ر.س"
- ❌ "يجب تسجيل الدخول لإضافة مصروف"

### رسائل التأكيد
- ❓ "هل أنت متأكد من خصم [المبلغ] ر.س من عهدتك؟"
- ❓ "هل أنت متأكد من رفض هذه العهدة؟"

## ملاحظات مهمة

### الأمان
- جميع العمليات تُسجل مع معرّف المستخدم والتاريخ
- الموظف لا يمكنه تأكيد عهد موظفين آخرين
- المدير فقط يمكنه إضافة عهد للموظفين

### تزامن البيانات
- استخدام معاملات قاعدة البيانات لضمان تطابق البيانات
- تحديث الرصيد يتم فقط عند تأكيد العهدة
- الخصم من العهدة يتم فوراً مع إنشاء معاملة مرتبطة

### التدقيق
- سجل كامل لجميع العمليات
- تتبع من قام بكل عملية ومتى
- حفظ حالة كل معاملة (pending, confirmed, rejected)

## التطبيق على قاعدة البيانات

لتطبيق التغييرات على قاعدة البيانات:

1. افتح Supabase SQL Editor
2. نفذ محتويات ملف `migrations/001_add_custody_fields.sql`
3. تأكد من نجاح جميع الأوامر

## الدعم الفني

في حالة وجود أي مشاكل أو استفسارات:
- راجع الرسائل التوضيحية في النظام
- تحقق من سجل العمليات
- تواصل مع المسؤول التقني
